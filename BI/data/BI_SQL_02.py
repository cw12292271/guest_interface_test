sql_数据总览 = dict(
    当前排队人数="select count(*) from chat_queue where cid = '{cid}' and start_time >= '{today}' and status = 1",
    当前人工接入量="select count(*) from chat_session where cid = '{cid}' and created >= '{today}' and creator in (1,9,10,11,12,13,14,15) and status != 2",
    当前机器人接待量="select count(*) from chat_session where cid = '{cid}' and created >= '{today}' and creator = 0 and status != 2",
    当前可接待客服="select count( user_id = {user_id}' order by user_id asc,created desc) t group by user_id) q where q.lastest_content = '可接待'",
    今日相对满意度='''select count(case when satisfaction=4 or satisfaction=5 then 1 else null end)/count(case when satisfaction is not null then 1 else null end) from (select ori_session as ori from chat_session where cid = '{cid}'  and creator in (1,8)) s1 left join chat_session s2 on s1.ori = s2.ori_session where creator != 8 ''',
    参评率='''select count(case when satisfaction is not null then 1 else null end)/count(distinct ori) from (select ori_session as ori from chat_session where cid = '{cid}'  and creator in (1,8)) s1 left join chat_session s2 on s1.ori = s2.ori_session where creator != 8 ''',
    今日访问量='''select count(*) from chat_session where cid = '{cid}' and created >= '{today}' and creator = 0''',
    今日访客人数='''select count(distinct uid) from chat_session where cid = '{cid}' and created >= '{today}' and creator = 0''',

    今日会话时长='''select format(sum(dif_second)/count(*),0) from (select *,(UNIX_TIMESTAMP(t5.stop_time) - UNIX_TIMESTAMP(t5.created)) dif_second from (select sid,ori_session,ori,min(created) as created,max(stop_time) as stop_time,creator from chat_session t3 left join (select t1.ori_session as ori from (select * from chat_session where cid = '{cid}' and creator in (1,8,9,10,11,12,13,14,15) and created >= '{today}') t1 right join (select ori_session from chat_session s right join (select sid as lsid,created as lcreated from chat_log where source = 9 and raw like '%%"from": "kf"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%' and cid = '{cid}' and created >= '{today}') l on s.sid = l.lsid) t2 on t1.sid = t2.ori_session ) t4 on t3.ori_session = t4.ori where ori is not null and creator != 8 group by ori) t5 ) t6''',
    今日平均响应时长='''select sum(t6.dif_second)/count(t6.sid1) from (select *,(UNIX_TIMESTAMP(t5.updated2) - UNIX_TIMESTAMP(t5.updated1)) dif_second from (select * from(select * from(select t1.sid as sid1,t2.sid as sid2,t1.updated as updated1,t1.raw as raw1,t2.updated as updated2,t2.raw as raw2 from (select l.* from (select * from chat_log where cid = '{cid}' and created >= '{today}' and created < '{end}' and ((raw like '%%"from": "kf"%%' and raw like '%%"is_sys_send": 1%%' and raw like '%%"msg_type": "event"%%') or (raw like '%%"from": "user"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%' and raw not like '%%"text": "转机器人"%%'))) l right join (select * from chat_session  where  cid = '{cid}' and created >= '{today}' and created < '{end}' and creator in (1,4,5,6,7,9,10,11,12,13,14,15,16,17,18) ) s on s.sid = l.sid ) t1 right join (select * from (select l.*,s.creator from chat_session s right join (select * from chat_log where  cid = '{cid}' and created >= '{today}' and created < '{end}' and source = 9 and raw like '%%"from": "kf"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%') l on s.sid = l.sid) t where t.creator in (1,4,5,6,7,9,10,11,12,13,14,15,16,17,18)) t2 on t1.sid = t2.sid  having updated2>updated1) t3 group by updated1 having min(updated2) ) t4 group by updated2 having min(updated1) ) t5) t6 ''',
    今日机器人接待量='''select count(*) from chat_session where cid = '{cid}' and created >= '{today}' and creator = 0''',
    今日机器人解决量="select count(*) from chat_session where cid = '{cid}' and created >= '{today}'  and ((creator = 0 and stop_way = 7) or (creator = 8 and stop_way in(13,16))) ",
    今日机器人未解决量="select count(*) from chat_session where cid = '{cid}' and created >= '{today}' and creator in(1,9,10,11,12,13,14,15) and status = 2",

    今日访客提问数='''select count(id) from chat_log where cid = '{cid}' and created >= '{today}' and raw regexp '"from_code"(: 8,|: 17,|: 21,|: 9,|: 20,|: 16,|: 2,|: 3,|: 19,|: 7,|: 22,|: 1,|: 15,|: 10,|: 18,|: 5,|: 25,|: 26,|: 27,|: 6,|: 4,|: 13,|: 23,|: 12,|: 28,)' and source = "1"''',
    今日匹配提问数='''select count(id) from chat_log where cid = '{cid}' and created >= '{today}' and raw regexp '"from_code"(: 8,|: 17,|: 21,|: 9,|: 20,|: 16,|: 2,|: 3,|: 19,|: 7,|: 22,|: 1,|: 15,|: 10,|: 18,|: 5,|: 25,|: 26,|: 27,)' and source = "1"''',
    转人工数量='''select count(sid) from chat_session where ext_bi = '{to_kf}' and (cid = '{cid}' and created >= '{today}')''',
    进入排队人数="select count(*) from chat_queue where cid = '{cid}' and today >= '{}'",
    排队进入人工="select count(*) from chat_session where creator = 8 and stop_way in (14,15,17,19,20) and cid = '{cid}' and created >= '{today}' ",
    接入会话量="select count(*) from chat_session where cid = '{cid}' and created >= '{today}' and creator in (1,9,10,11,12,13,14,15) and status = 2",
)

sql_机器人数据 = dict(
    机器人接待量="select count(*) from chat_session \
    where cid = '{cid}'and created >= '{start}' and created < '{end}' and creator = 0 ",
    机器人解决量="select count(*) from chat_session where cid = '{cid}'and created >= '{start}' and created < '{end}'  and \
    ((creator = 0 and stop_way = 7) or (creator = 8 and stop_way in(13,16))) ",  # 机器人未解决量 == 机器人转人工会话量
    机器人未解决量="select count(t1.sid) from(select * from chat_session where '{cid}' and created >= '{start}' and creator in (1,9,10,11,12,13,14,15) and status = 2) t1 right join (select sid from chat_session where cid = '{cid}' and created >= '{start}' and created < '{end}') t2 on t1.ori_session = t2.sid ",
    访客提问数='''select count(id) from chat_log where cid = '{cid}' and created >= '{start}' and created < '{end}' and \
    raw regexp '"from_code"(: 8,|: 17,|: 21,|: 9,|: 20,|: 16,|: 2,|: 3,|: 19,|: 7,|: 22,|: 1,|: 15,|: 10,|: 18,|: 5,\
    |: 25,|: 26,|: 27,|: 6,|: 4,|: 13,|: 23,|: 12,|: 28,)' and source = "1"''',
    匹配提问数='''select count(id) from chat_log where cid = '{cid}' and created >= '{start}' and created < '{end}' and \
    raw regexp '"from_code"(: 8,|: 17,|: 21,|: 9,|: 20,|: 16,|: 2,|: 3,|: 19,|: 7,|: 22,|: 1,|: 15,|: 10,|: 18,|: 5,\
    |: 25,|: 26,|: 27,)' and source = "1"'''
)

sql_客服数据总览 = dict(
    转人工数量='''select count(sid) from chat_session where ext_bi = '{to_kf}' and (cid = '{cid}' and created >= '{start}' and created < '{end}')''',
    进入排队人数="select count(*) from chat_queue where cid = '{cid}' and start_time >= '{start}' and start_time < '{end}'",
    排队进入人工="select count(*) from chat_session where creator = 8 and stop_way in (14,15,17,19,20) and cid = '{cid}' and created >= '{start}' and created < '{end}'",
    接入会话量="select count(*) from chat_session where cid = '{cid}' and created >= '{start}' and created < '{end}' and creator in (1,9,10,11,12,13,14,15) and status = 2",
    接待会话量='''select count(*) from (select sid,ori_session,ori,min(created),max(stop_time),creator from chat_session t3 left join (select t1.ori_session as ori from (select * from chat_session where cid = '{cid}' and creator in (1,8,9,10,11,12,13,14,15) and status = 2 and created >= '{start}' and created < '{end}') t1 right join (select ori_session from chat_session s right join (select sid as lsid,created as lcreated from chat_log where source = 9 and raw like '%%"from": "kf"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%' and cid = '{cid}' and created >= '{start}') l on s.sid = l.lsid) t2 on t1.sid = t2.ori_session ) t4 on t3.ori_session = t4.ori where ori is not null and creator != 8 group by ori) t5''',
    独立接待量='''select count(*) from (select *,count(ori) as count from (select ori from chat_session t3 left join (select t1.ori_session as ori from (select * from chat_session where cid = '{cid}' and creator in (1,8,9,10,11,12,13,14,15) and status = 2 and created >= '{start}' and created < '{end}') t1 right join (select ori_session from chat_session s right join (select sid as lsid,created as lcreated from chat_log where source = 9 and raw like '%%"from": "kf"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%' and cid = '{cid}' and created >= '{start}') l on s.sid = l.lsid) t2 on t1.sid = t2.ori_session ) t4 on t3.ori_session = t4.ori where ori is not null and creator != 8 group by ori ) t5 left join (select * from chat_session ) t6 on t5.ori = t6.ori_session  group by ori having count = 1) t7''',
    总消息量='''select count(distinct msg_id) from (select sid from chat_session where cid = '{cid}' and created >= '{start}' and created < '{end}' and creator in (1,8) and status = 2) s  left join (select s1.ori_session as ori, l1.* from (select * from chat_log where ((raw like '%%"from": "user"%%' or raw like '%%"from": "kf"%%') and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%' and raw not like '%%"text": "转机器人"%%'  ) and cid = '{cid}'  and created >= '{start}' and created < '{end}' and source = 9) l1 left join chat_session s1 on l1.sid = s1.sid) l on s.sid = l.ori''',
    客服消息量='''select count(distinct msg_id) from (select sid from chat_session where cid = '{cid}' and created >= '{start}' and created < '{end}' and creator in (1,8) and status = 2) s  left join (select s1.ori_session as ori, l1.* from (select * from chat_log where (raw like '%%"from": "kf"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%' ) and cid = '{cid}'  and created >= '{start}' and created < '{end}' and source = 9) l1 left join chat_session s1 on l1.sid = s1.sid) l on s.sid = l.ori''',
    访客消息量='''select count(distinct msg_id) from (select sid from chat_session where cid = '{cid}' and created >= '{start}' and created < '{end}' and creator in (1,8) and status = 2) s  left join (select s1.ori_session as ori, l1.* from (select * from chat_log where (raw like '%%"from": "user"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%' and raw not like '%%"text": "转机器人"%%'  ) and cid = '{cid}'  and created >= '{start}' and created < '{end}' and source = 9) l1 left join chat_session s1 on l1.sid = s1.sid) l on s.sid = l.ori''',
)

sql_客服数据时长总览 = dict(
    平均会话时长='''select format(sum(dif_second)/count(*),0) from (select *,(UNIX_TIMESTAMP(t5.stop_time) - UNIX_TIMESTAMP(t5.created)) dif_second from (select sid,ori_session,ori,min(created) as created,max(stop_time) as stop_time,creator from chat_session t3 left join (select t1.ori_session as ori from (select * from chat_session where cid = '{cid}' and creator in (1,8,9,10,11,12,13,14,15) and created >= '{start}' and created < '{end}') t1 right join (select ori_session from chat_session s right join (select sid as lsid,created as lcreated from chat_log where source = 9 and raw like '%%"from": "kf"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%' and cid = '{cid}' and created >= '{start}') l on s.sid = l.lsid) t2 on t1.sid = t2.ori_session ) t4 on t3.ori_session = t4.ori where ori is not null and creator != 8 group by ori) t5 ) t6''',
    会话时长大于8min='''select format(count(case when dif_second>480 then 1 else null end)/count(*),4) from (select *,(UNIX_TIMESTAMP(t5.stop_time) - UNIX_TIMESTAMP(t5.created)) dif_second from (select sid,ori_session,ori,min(created) as created,max(stop_time) as stop_time,creator from chat_session t3 left join (select t1.ori_session as ori from (select * from chat_session where cid = '{cid}' and creator in (1,8,9,10,11,12,13,14,15) and created >= '{start}' and created < '{end}') t1 right join (select ori_session from chat_session s right join (select sid as lsid,created as lcreated from chat_log where source = 9 and raw like '%%"from": "kf"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%' and cid = '{cid}' and created >= '{start}') l on s.sid = l.lsid) t2 on t1.sid = t2.ori_session ) t4 on t3.ori_session = t4.ori where ori is not null and creator != 8 group by ori) t5 ) t6''',
    会话时长介于6min到8min='''select format(count(case when dif_second>360 and dif_second<=480 then 1 else null end)/count(*),4) from (select *,(UNIX_TIMESTAMP(t5.stop_time) - UNIX_TIMESTAMP(t5.created)) dif_second from (select sid,ori_session,ori,min(created) as created,max(stop_time) as stop_time,creator from chat_session t3 left join (select t1.ori_session as ori from (select * from chat_session where cid = '{cid}' and creator in (1,8,9,10,11,12,13,14,15) and created >= '{start}' and created < '{end}') t1 right join (select ori_session from chat_session s right join (select sid as lsid,created as lcreated from chat_log where source = 9 and raw like '%%"from": "kf"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%' and cid = '{cid}' and created >= '{start}') l on s.sid = l.lsid) t2 on t1.sid = t2.ori_session ) t4 on t3.ori_session = t4.ori where ori is not null and creator != 8 group by ori) t5 ) t6''',
    会话时长介于4min到6min='''select format(count(case when dif_second>240 and dif_second<=360 then 1 else null end)/count(*),4) from (select *,(UNIX_TIMESTAMP(t5.stop_time) - UNIX_TIMESTAMP(t5.created)) dif_second from (select sid,ori_session,ori,min(created) as created,max(stop_time) as stop_time,creator from chat_session t3 left join (select t1.ori_session as ori from (select * from chat_session where cid = '{cid}' and creator in (1,8,9,10,11,12,13,14,15) and created >= '{start}' and created < '{end}') t1 right join (select ori_session from chat_session s right join (select sid as lsid,created as lcreated from chat_log where source = 9 and raw like '%%"from": "kf"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%' and cid = '{cid}' and created >= '{start}') l on s.sid = l.lsid) t2 on t1.sid = t2.ori_session ) t4 on t3.ori_session = t4.ori where ori is not null and creator != 8 group by ori) t5 ) t6''',
    会话时长介于2min到4min='''select format(count(case when dif_second>120 and dif_second<=240 then 1 else null end)/count(*),4) from (select *,(UNIX_TIMESTAMP(t5.stop_time) - UNIX_TIMESTAMP(t5.created)) dif_second from (select sid,ori_session,ori,min(created) as created,max(stop_time) as stop_time,creator from chat_session t3 left join (select t1.ori_session as ori from (select * from chat_session where cid = '{cid}' and creator in (1,8,9,10,11,12,13,14,15) and created >= '{start}' and created < '{end}') t1 right join (select ori_session from chat_session s right join (select sid as lsid,created as lcreated from chat_log where source = 9 and raw like '%%"from": "kf"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%' and cid = '{cid}' and created >= '{start}') l on s.sid = l.lsid) t2 on t1.sid = t2.ori_session ) t4 on t3.ori_session = t4.ori where ori is not null and creator != 8 group by ori) t5 ) t6''',
    会话时长小于等于2min='''select format(count(case when dif_second<=120 then 1 else null end)/count(*),4) from (select *,(UNIX_TIMESTAMP(t5.stop_time) - UNIX_TIMESTAMP(t5.created)) dif_second from (select sid,ori_session,ori,min(created) as created,max(stop_time) as stop_time,creator from chat_session t3 left join (select t1.ori_session as ori from (select * from chat_session where cid = '{cid}' and creator in (1,8,9,10,11,12,13,14,15) and created >= '{start}' and created < '{end}') t1 right join (select ori_session from chat_session s right join (select sid as lsid,created as lcreated from chat_log where source = 9 and raw like '%%"from": "kf"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%' and cid = '{cid}' and created >= '{start}') l on s.sid = l.lsid) t2 on t1.sid = t2.ori_session ) t4 on t3.ori_session = t4.ori where ori is not null and creator != 8 group by ori) t5 ) t6''',
    平均首次响应时长='''select format(sum(t.dif_second)/count(distinct ori_session),0) from (select *,(UNIX_TIMESTAMP(created) - UNIX_TIMESTAMP(created1)) dif_second  from (select ori,created as created1 from (select ori_session as ori from chat_session where cid = '{cid}' and  created >= '{start}' and created < '{end}' and status = 2 and creator in (1,8)) s1 left join chat_session s2 on s1.ori = s2.ori_session where creator != 8 group by ori having min(created1))  s left join (select s1.ori_session,l1.created from (select * from chat_log where source = 9 and cid = '{cid}' and raw like '%%"from": "kf"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%') l1 left join chat_session s1 on l1.sid = s1.sid group by ori_session having min(l1.created)) l on s.ori = l.ori_session) t ''',
    首次响应时长大于1min占比='''select format(count(case when t.dif_second>60 then 1 else null end)/count(distinct ori_session),4) from (select *,(UNIX_TIMESTAMP(created) - UNIX_TIMESTAMP(created1)) dif_second  from (select ori,created as created1 from (select ori_session as ori from chat_session where cid = '{cid}' and status = 2 and  created >= '{start}' and created < '{end}' and creator in (1,8)) s1 left join chat_session s2 on s1.ori = s2.ori_session where creator != 8 group by ori having min(created1))  s left join (select s1.ori_session,l1.created from (select * from chat_log where source = 9 and cid = '{cid}' and raw like '%%"from": "kf"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%') l1 left join chat_session s1 on l1.sid = s1.sid group by ori_session having min(l1.created)) l on s.ori = l.ori_session) t''',
    首次响应时长介于45s到1min占比='''select format(count(case when t.dif_second>45 and t.dif_second <= 60 then 1 else null end)/count(distinct ori_session),4) from (select *,(UNIX_TIMESTAMP(created) - UNIX_TIMESTAMP(created1)) dif_second  from (select ori,created as created1 from (select ori_session as ori from chat_session where cid = '{cid}' and  created >= '{start}' and created < '{end}' and status = 2 and creator in (1,8)) s1 left join chat_session s2 on s1.ori = s2.ori_session where creator != 8 group by ori having min(created1))  s left join (select s1.ori_session,l1.created from (select * from chat_log where source = 9 and cid = '{cid}' and raw like '%%"from": "kf"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%') l1 left join chat_session s1 on l1.sid = s1.sid group by ori_session having min(l1.created)) l on s.ori = l.ori_session) t''',
    首次响应时长介于30s到45s占比='''select format(count(case when t.dif_second > 30 and t.dif_second <= 45 then 1 else null end)/count(distinct ori_session),4) from (select *,(UNIX_TIMESTAMP(created) - UNIX_TIMESTAMP(created1)) dif_second  from (select ori,created as created1 from (select ori_session as ori from chat_session where cid = '{cid}' and  created >= '{start}' and created < '{end}' and status = 2 and creator in (1,8)) s1 left join chat_session s2 on s1.ori = s2.ori_session where creator != 8 group by ori having min(created1))  s left join (select s1.ori_session,l1.created from (select * from chat_log where source = 9 and cid = '{cid}' and raw like '%%"from": "kf"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%') l1 left join chat_session s1 on l1.sid = s1.sid group by ori_session having min(l1.created)) l on s.ori = l.ori_session) t''',
    首次响应时长介于15s到30s占比='''select format(count(case when t.dif_second > 15 and t.dif_second <= 30 then 1 else null end)/count(distinct ori_session),4) from (select *,(UNIX_TIMESTAMP(created) - UNIX_TIMESTAMP(created1)) dif_second  from (select ori,created as created1 from (select ori_session as ori from chat_session where cid = '{cid}' and  created >= '{start}' and created < '{end}' and status = 2 and creator in (1,8)) s1 left join chat_session s2 on s1.ori = s2.ori_session where creator != 8 group by ori having min(created1))  s left join (select s1.ori_session,l1.created from (select * from chat_log where source = 9 and cid = '{cid}' and raw like '%%"from": "kf"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%') l1 left join chat_session s1 on l1.sid = s1.sid group by ori_session having min(l1.created)) l on s.ori = l.ori_session) t''',
    首次响应时长小于等于15s占比='''select format(count(case when t.dif_second <= 15 then 1 else null end)/count(distinct ori_session),4) from (select *,(UNIX_TIMESTAMP(created) - UNIX_TIMESTAMP(created1)) dif_second  from (select ori,created as created1 from (select ori_session as ori from chat_session where cid = '{cid}' and  created >= '{start}' and created < '{end}' and status = 2 and creator in (1,8)) s1 left join chat_session s2 on s1.ori = s2.ori_session where creator != 8 group by ori having min(created1))  s left join (select s1.ori_session,l1.created from (select * from chat_log where source = 9 and cid = '{cid}' and raw like '%%"from": "kf"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%') l1 left join chat_session s1 on l1.sid = s1.sid group by ori_session having min(l1.created)) l on s.ori = l.ori_session) t''',
    平均响应时长='''select format(sum(dif_second)/count(*),0) from (select *,(UNIX_TIMESTAMP(t6.created2) - UNIX_TIMESTAMP(t6.created1)) dif_second from (select * from (select ori from (select ori_session as ori from chat_session where cid = '{cid}' and  created >= '{start}' and created < '{end}' and creator in (1,8)) s1 left join chat_session s2 on s1.ori = s2.ori_session where creator != 8 )  s right join (select * from (select * from (select t1.ori_session as ori1,t1.created as created1,t1.raw as raw1,t2.created as created2,t2.raw as raw2  from (select l1.sid,s1.ori_session,l1.created,l1.raw from (select * from chat_log where source = 9 and cid = '{cid}' and ((raw like '%%"from": "user"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%' and raw not like '%%"text": "转机器人"%%') or (raw like '%%"event_type": "分配客服"%%')) ) l1 left join chat_session s1 on l1.sid = s1.sid order by ori_session ,created asc) t1 right join (select l1.sid,s1.ori_session,l1.created,l1.raw from (select * from chat_log where source = 9 and cid = '{cid}' and ((raw like '%%"from": "kf"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%'))) l1 left join chat_session s1 on l1.sid = s1.sid order by created asc) t2 on t1.ori_session = t2.ori_session having created2 > created1 ) t3 group by created1 having min(created2) ) t4 group by created2 having min(created1)) t5 on s.ori = t5.ori1 group by created1) t6 where ori is not null)t7''',
    响应时长大于1min占比='''select format(count(case when dif_second>60 then 1 else null end)/count(*),4) from (select *,(UNIX_TIMESTAMP(t6.created2) - UNIX_TIMESTAMP(t6.created1)) dif_second from (select * from (select ori from (select ori_session as ori from chat_session where cid = '{cid}' and  created >= '{start}' and created < '{end}' and creator in (1,8)) s1 left join chat_session s2 on s1.ori = s2.ori_session where creator != 8 )  s right join (select * from (select * from (select t1.ori_session as ori1,t1.created as created1,t1.raw as raw1,t2.created as created2,t2.raw as raw2  from (select l1.sid,s1.ori_session,l1.created,l1.raw from (select * from chat_log where source = 9 and cid = '{cid}' and ((raw like '%%"from": "user"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%' and raw not like '%%"text": "转机器人"%%') or (raw like '%%"event_type": "分配客服"%%')) ) l1 left join chat_session s1 on l1.sid = s1.sid order by ori_session ,created asc) t1 right join (select l1.sid,s1.ori_session,l1.created,l1.raw from (select * from chat_log where source = 9 and cid = '{cid}' and ((raw like '%%"from": "kf"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%'))) l1 left join chat_session s1 on l1.sid = s1.sid order by created asc) t2 on t1.ori_session = t2.ori_session having created2 > created1 ) t3 group by created1 having min(created2) ) t4 group by created2 having min(created1)) t5 on s.ori = t5.ori1 group by created1) t6 where ori is not null)t7''',
    响应时长介于45s到1min占比='''select format(count(case when dif_second>45 and dif_second<=60 then 1 else null end)/count(*),4) from (select *,(UNIX_TIMESTAMP(t6.created2) - UNIX_TIMESTAMP(t6.created1)) dif_second from (select * from (select ori from (select ori_session as ori from chat_session where cid = '{cid}' and  created >= '{start}' and created < '{end}' and creator in (1,8)) s1 left join chat_session s2 on s1.ori = s2.ori_session where creator != 8 )  s right join (select * from (select * from (select t1.ori_session as ori1,t1.created as created1,t1.raw as raw1,t2.created as created2,t2.raw as raw2  from (select l1.sid,s1.ori_session,l1.created,l1.raw from (select * from chat_log where source = 9 and cid = '{cid}' and ((raw like '%%"from": "user"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%' and raw not like '%%"text": "转机器人"%%') or (raw like '%%"event_type": "分配客服"%%')) ) l1 left join chat_session s1 on l1.sid = s1.sid order by ori_session ,created asc) t1 right join (select l1.sid,s1.ori_session,l1.created,l1.raw from (select * from chat_log where source = 9 and cid = '{cid}' and ((raw like '%%"from": "kf"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%'))) l1 left join chat_session s1 on l1.sid = s1.sid order by created asc) t2 on t1.ori_session = t2.ori_session having created2 > created1 ) t3 group by created1 having min(created2) ) t4 group by created2 having min(created1)) t5 on s.ori = t5.ori1 group by created1) t6 where ori is not null)t7''',
    响应时长介于30s到45s占比='''select format(count(case when dif_second>30 and dif_second<=45 then 1 else null end)/count(*),4) from (select *,(UNIX_TIMESTAMP(t6.created2) - UNIX_TIMESTAMP(t6.created1)) dif_second from (select * from (select ori from (select ori_session as ori from chat_session where cid = '{cid}' and  created >= '{start}' and created < '{end}' and creator in (1,8)) s1 left join chat_session s2 on s1.ori = s2.ori_session where creator != 8 )  s right join (select * from (select * from (select t1.ori_session as ori1,t1.created as created1,t1.raw as raw1,t2.created as created2,t2.raw as raw2  from (select l1.sid,s1.ori_session,l1.created,l1.raw from (select * from chat_log where source = 9 and cid = '{cid}' and ((raw like '%%"from": "user"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%' and raw not like '%%"text": "转机器人"%%') or (raw like '%%"event_type": "分配客服"%%')) ) l1 left join chat_session s1 on l1.sid = s1.sid order by ori_session ,created asc) t1 right join (select l1.sid,s1.ori_session,l1.created,l1.raw from (select * from chat_log where source = 9 and cid = '{cid}' and ((raw like '%%"from": "kf"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%'))) l1 left join chat_session s1 on l1.sid = s1.sid order by created asc) t2 on t1.ori_session = t2.ori_session having created2 > created1 ) t3 group by created1 having min(created2) ) t4 group by created2 having min(created1)) t5 on s.ori = t5.ori1 group by created1) t6 where ori is not null)t7''',
    响应时长介于15s到30s占比='''select format(count(case when dif_second>15 and dif_second<=30 then 1 else null end)/count(*),4) from (select *,(UNIX_TIMESTAMP(t6.created2) - UNIX_TIMESTAMP(t6.created1)) dif_second from (select * from (select ori from (select ori_session as ori from chat_session where cid = '{cid}' and  created >= '{start}' and created < '{end}' and creator in (1,8)) s1 left join chat_session s2 on s1.ori = s2.ori_session where creator != 8 )  s right join (select * from (select * from (select t1.ori_session as ori1,t1.created as created1,t1.raw as raw1,t2.created as created2,t2.raw as raw2  from (select l1.sid,s1.ori_session,l1.created,l1.raw from (select * from chat_log where source = 9 and cid = '{cid}' and ((raw like '%%"from": "user"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%' and raw not like '%%"text": "转机器人"%%') or (raw like '%%"event_type": "分配客服"%%')) ) l1 left join chat_session s1 on l1.sid = s1.sid order by ori_session ,created asc) t1 right join (select l1.sid,s1.ori_session,l1.created,l1.raw from (select * from chat_log where source = 9 and cid = '{cid}' and ((raw like '%%"from": "kf"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%'))) l1 left join chat_session s1 on l1.sid = s1.sid order by created asc) t2 on t1.ori_session = t2.ori_session having created2 > created1 ) t3 group by created1 having min(created2) ) t4 group by created2 having min(created1)) t5 on s.ori = t5.ori1 group by created1) t6 where ori is not null)t7''',
    响应时长小于等于15s占比='''select format(count(case when dif_second<=15 then 1 else null end)/count(*),4) from (select *,(UNIX_TIMESTAMP(t6.created2) - UNIX_TIMESTAMP(t6.created1)) dif_second from (select * from (select ori from (select ori_session as ori from chat_session where cid = '{cid}' and  created >= '{start}' and created < '{end}' and creator in (1,8)) s1 left join chat_session s2 on s1.ori = s2.ori_session where creator != 8 )  s right join (select * from (select * from (select t1.ori_session as ori1,t1.created as created1,t1.raw as raw1,t2.created as created2,t2.raw as raw2  from (select l1.sid,s1.ori_session,l1.created,l1.raw from (select * from chat_log where source = 9 and cid = '{cid}' and ((raw like '%%"from": "user"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%' and raw not like '%%"text": "转机器人"%%') or (raw like '%%"event_type": "分配客服"%%')) ) l1 left join chat_session s1 on l1.sid = s1.sid order by ori_session ,created asc) t1 right join (select l1.sid,s1.ori_session,l1.created,l1.raw from (select * from chat_log where source = 9 and cid = '{cid}' and ((raw like '%%"from": "kf"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%'))) l1 left join chat_session s1 on l1.sid = s1.sid order by created asc) t2 on t1.ori_session = t2.ori_session having created2 > created1 ) t3 group by created1 having min(created2) ) t4 group by created2 having min(created1)) t5 on s.ori = t5.ori1 group by created1) t6 where ori is not null)t7''',
)

sql_客服工作量 = dict(
    接入会话量="select count(distinct sid) from (select ori_session as ori1 from chat_session where cid = '{cid}' and creator in (1,8) and status = 2 and  created < '{end}') t1 right join (select * from chat_session where creator in (1,4,5,6,7,9,10,11,12,13,14,15,16,17,18)  and status = 2 and cid = '{cid}' and created >= '{start}' and created < '{end}' and  user_id = '{user_id}') t2 on t1.ori1 = t2.ori_session where ori1 is not null and creator != 8",

    接待会话量='''select count(distinct sid) from (select ori_session as ori1 from chat_session where cid = '{cid}' and creator in (1,8) and status = 2 and created < '{end}') t1 right join (select * from (select * from chat_session where status = 2 and user_id = '{user_id}' and created >= '{start}' and created < '{end}' ) s right join (select sid as lsid from chat_log where raw like '%%"from": "kf"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%' and cid = '{cid}' and created >= '{start}') l on s.sid = l.lsid) t2 on t1.ori1 = t2.ori_session where ori1 is not null and creator != 8''',

    独立接待量='''select count(*) from (select *,count(ori) as count from (select ori from chat_session t3 left join (select t1.ori_session as ori from (select * from chat_session where cid = '{cid}' and creator in (1,8,9,10,11,12,13,14,15) and status = 2 and created >= '{start}' and created < '{end}') t1 right join (select ori_session from chat_session s right join (select sid as lsid,created as lcreated from chat_log where source = 9 and raw like '%%"from": "kf"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%' and cid = '{cid}' and created >= '{start}') l on s.sid = l.lsid) t2 on t1.sid = t2.ori_session ) t4 on t3.ori_session = t4.ori where ori is not null and creator != 8 group by ori ) t5 left join (select * from chat_session ) t6 on t5.ori = t6.ori_session  group by ori having count = 1) t7 where  user_id = {user_id}''',

    首次未响应会话量="select count(sid) from chat_session where stop_way in (0,10) and  cid = '{cid}' and created >= '{start}' and created < '{end}' and  user_id = '{user_id}'",

    有效会话量='''select count(distinct sid) from (select ori_session as ori1 from chat_session where cid = '{cid}' and creator in (1,8) and status = 2 and created < '{end}') t1 right join (select * from (select * from chat_session where status = 2 and user_id = '{user_id}' and created >= '{start}' and created < '{end}' ) s right join (select sid as lsid from chat_log where raw like '%%"from": "user"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%' and raw not like '%%"text": "转机器人"%%' and cid = '{cid}' and created >= '{start}') l on s.sid = l.lsid) t2 on t1.ori1 = t2.ori_session where ori1 is not null and creator != 8''',

    结束会话量='''select count(sid) from (select t1.* from (select s.* from(select * from chat_session where creator in (1,4,5,6,7,9,10,11,12,13,14,15,16,17,18) and status = 2) s right join (select sid as lsid from chat_log where source = 9 and raw like '%%"kf_id": "{user_id}"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%' and cid = '{cid}' and created >= '{start}' and created < '{end}') l on s.sid = l.lsid where sid is not null) t1 left join (select * from chat_session where creator in (1,8,9,10,11,12,13,14,15) and status = 2 and cid = '{cid}' and created < '{end}') t2 on t1.ori_session = t2.sid group by sid) t3 where stop_way in (0,1,2,3,6,12,27)''',

    主动会话量="select count(*) from chat_session where creator in (2,3) and  cid = '{cid}' and created >= '{start}' and created < '{end}' and  user_id = '{user_id}'",

    主动转接量="select count(*) from chat_session where creator in (1,4,5,6,7,9,10,11,12,13,14,15,16,17,18) and stop_way in (9,25) and  cid = '{cid}' and created >= '{start}' and created < '{end}' and  user_id = '{user_id}'"
)

sql_客服工作质量 = dict(
    平均首次响应时长='''select format(sum(t3.dif_second)/count(*),0) from (select *,(UNIX_TIMESTAMP(t2.created2) - UNIX_TIMESTAMP(t2.created1)) dif_second from (select * from (select s.creator,s.created as created1,lt.created as created2 from chat_session s right join (select * from (select sid,created from chat_log where source = 9 and raw like '%%"kf_id": "{user_id}"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%' and  cid = '{cid}' and created >= '{start}' and created < '{end}') l group by l.sid having min(l.created)) lt on s.sid = lt.sid) t where t.creator in (1,4,5,6,7,9,10,11,12,13,14,15)) t2) t3''',

    平均响应时长='''select format(sum(dif_second)/count(*),0) from (select *,(UNIX_TIMESTAMP(t6.created2) - UNIX_TIMESTAMP(t6.created1)) dif_second from (select s.sid as sid1,t5.* from (select sid from (select ori_session as ori from chat_session where cid = '{cid}' and  created >= '{start}' and created < '{end}' and user_id = {user_id} and creator in (1,8)) s1 left join chat_session s2 on s1.ori = s2.ori_session where creator != 8 )  s left join (select * from (select * from (select t1.sid,t1.created as created1,t1.raw as raw1,t2.created as created2,t2.raw as raw2  from (select * from chat_log where source = 9 and cid = '{cid}' and  created >= '{start}' and created < '{end}' and ((raw like '%%"from": "user"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%' and raw not like '%%"text": "转机器人"%%') or (raw like '%%"event_type": "分配客服"%%')) ) t1 right join (select * from chat_log where source = 9 and cid = '{cid}' and  created >= '{start}' and created < '{end}' and ((raw like '%%"from": "kf"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%'))) t2 on t1.sid = t2.sid having created2 > created1 ) t3 group by created1 having min(created2) ) t4 group by created2 having min(created1)) t5 on s.sid = t5.sid group by created1) t6 where sid is not null) t7''',

    客服30秒应答率='''select format(count(case when dif_second < 30 then 1 else null end)/count(sid1),4) from (select *,(UNIX_TIMESTAMP(t6.created2) - UNIX_TIMESTAMP(t6.created1)) dif_second from (select s.sid as sid1,t5.* from (select sid from (select ori_session as ori from chat_session where cid = '{cid}' and  created >= '{start}' and created < '{end}' and user_id = {user_id} and creator in (1,8)) s1 left join chat_session s2 on s1.ori = s2.ori_session where creator != 8 )  s left join (select * from (select * from (select t1.sid,t1.created as created1,t1.raw as raw1,t2.created as created2,t2.raw as raw2  from (select * from chat_log where source = 9 and cid = '{cid}' and  created >= '{start}' and created < '{end}' and ((raw like '%%"from": "user"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%' and raw not like '%%"text": "转机器人"%%') or (raw like '%%"event_type": "分配客服"%%')) ) t1 right join (select * from chat_log where source = 9 and cid = '{cid}' and  created >= '{start}' and created < '{end}' and ((raw like '%%"from": "kf"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%'))) t2 on t1.sid = t2.sid having created2 > created1 ) t3 group by created1 having min(created2) ) t4 group by created2 having min(created1)) t5 on s.sid = t5.sid group by created1) t6 where sid is not null) t7''',

    接待总时长="select format(sum(dif_second),0) from (select *,(UNIX_TIMESTAMP(stop_time) - UNIX_TIMESTAMP(created)) dif_second from (select ori_session as ori1 from chat_session where cid = '{cid}' and creator in (1,8) and created < '{end}') t1 right join (select * from chat_session where creator in (1,4,5,6,7,9,10,11,12,13,14,15,16,17,18) and status = 2 and cid = '{cid}' and created >= '{start}' and created < '{end}' and  user_id = '{user_id}') t2 on t1.ori1 = t2.ori_session where ori1 is not null and creator != 8) t3",

    平均接待时长="select format(sum(dif_second)/count(distinct sid),0) from (select *,(UNIX_TIMESTAMP(stop_time) - UNIX_TIMESTAMP(created)) dif_second from (select ori_session as ori1 from chat_session where cid = '{cid}' and creator in (1,8) and created < '{end}') t1 right join (select * from chat_session where creator in (1,4,5,6,7,9,10,11,12,13,14,15,16,17,18) and status = 2 and cid = '{cid}' and created >= '{start}' and created < '{end}' and  user_id = '{user_id}') t2 on t1.ori1 = t2.ori_session where ori1 is not null and creator != 8) t3",

    客服消息量='''select count(distinct msg_id) from (select ori from (select ori_session as ori from chat_session where cid = '{cid}'  and created >= '{start}' and created < '{end}' and creator in (1,8)) s1 left join chat_session s2 on s1.ori = s2.ori_session where creator != 8 )  s left join (select l1.sid,s1.ori_session,l1.created,l1.raw,l1.msg_id,s1.user_id from (select * from chat_log where cid = '{cid}'  and created >= '{start}' and created < '{end}' and ((raw like '%%"from": "kf"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%'))) l1 left join chat_session s1 on l1.sid = s1.sid order by created asc)  t on s.ori = t.ori_session where user_id = {user_id}''',

    访客消息量='''select count(distinct msg_id) from (select ori from (select ori_session as ori from chat_session where cid = '{cid}'  and created >= '{start}' and created < '{end}' and creator in (1,8)) s1 left join chat_session s2 on s1.ori = s2.ori_session where creator != 8 )  s left join (select l1.sid,s1.ori_session,l1.created,l1.raw,l1.msg_id,s1. user_id from (select * from chat_log where cid = '{cid}'  and created >= '{start}' and created < '{end}' and (raw like '%%"from": "user"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%' and raw not like '%%"text": "转机器人"%%')) l1 left join chat_session s1 on l1.sid = s1.sid order by created asc)  t on s.ori = t.ori_session where  user_id = {user_id}''',

    一次性解决量="select count(distinct(ori_session)) from chat_session where cid = '{cid}' and created >= '{start}' and created < '{end}' and  user_id = '{user_id}' and creator in (1,4,5,6,7,9,10,11,12,13,14,15,16,17,18) and one_solved_status =1",

    参评率='''select format(count(case when satisfaction is not null then 1 else null end)/count(sid),4) from (select ori_session as ori from chat_session where cid = '{cid}' and created >= '{start}' and created < '{end}' and creator in (1,8)) s1 left join chat_session s2 on s1.ori = s2.ori_session where creator != 8 and  user_id = {user_id}''',

    非常满意='''select count(case when satisfaction=5 then 1 else null end) from (select ori_session as ori from chat_session where cid = '{cid}' and created >= '{start}' and created < '{end}' and creator in (1,8)) s1 left join chat_session s2 on s1.ori = s2.ori_session where creator != 8 and  user_id = {user_id}''',

    满意='''select count(case when satisfaction=4 then 1 else null end) from (select ori_session as ori from chat_session where cid = '{cid}' and created >= '{start}'  and created < '{end}' and creator in (1,8)) s1 left join chat_session s2 on s1.ori = s2.ori_session where creator != 8 and  user_id = {user_id}''',

    一般='''select count(case when satisfaction=3 then 1 else null end) from (select ori_session as ori from chat_session where cid = '{cid}' and created >= '{start}'  and created < '{end}' and creator in (1,8)) s1 left join chat_session s2 on s1.ori = s2.ori_session where creator != 8 and  user_id = {user_id}''',

    不满意='''select count(case when satisfaction=2 then 1 else null end) from (select ori_session as ori from chat_session where cid = '{cid}'  and created >= '{start}' and created < '{end}' and creator in (1,8)) s1 left join chat_session s2 on s1.ori = s2.ori_session where creator != 8 and  user_id = {user_id}''',

    非常不满意='''select count(case when satisfaction=1 then 1 else null end) from (select ori_session as ori from chat_session where cid = '{cid}'  and created >= '{start}' and created < '{end}' and creator in (1,8)) s1 left join chat_session s2 on s1.ori = s2.ori_session where creator != 8 and  user_id = {user_id}''',
)

sql_客服详情_趋势 = dict(
    接入会话量="select count(distinct sid) from (select ori_session as ori1 from chat_session where cid = '{cid}' and creator in (1,8) and status = 2 and  created < '{end}') t1 right join (select * from chat_session where creator in (1,4,5,6,7,9,10,11,12,13,14,15,16,17,18)  and status = 2 and cid = '{cid}' and created >= '{start}' and created < '{end}' and  user_id = '{user_id}') t2 on t1.ori1 = t2.ori_session where ori1 is not null and creator != 8",

    接待会话量='''select count(distinct sid) from (select ori_session as ori1 from chat_session where cid = '{cid}' and creator in (1,8) and status = 2 and created < '{end}') t1 right join (select * from (select * from chat_session where status = 2 and user_id = '{user_id}' and created >= '{start}' and created < '{end}' ) s right join (select sid as lsid from chat_log where raw like '%%"from": "kf"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%' and cid = '{cid}' and created >= '{start}') l on s.sid = l.lsid) t2 on t1.ori1 = t2.ori_session where ori1 is not null and creator != 8''',

    独立接待量='''select count(*) from (select *,count(ori) as count from (select ori from chat_session t3 left join (select t1.ori_session as ori from (select * from chat_session where cid = '{cid}' and creator in (1,8,9,10,11,12,13,14,15) and status = 2 and created >= '{start}' and created < '{end}') t1 right join (select ori_session from chat_session s right join (select sid as lsid,created as lcreated from chat_log where source = 9 and raw like '%%"from": "kf"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%' and cid = '{cid}' and created >= '{start}') l on s.sid = l.lsid) t2 on t1.sid = t2.ori_session ) t4 on t3.ori_session = t4.ori where ori is not null and creator != 8 group by ori ) t5 left join (select * from chat_session ) t6 on t5.ori = t6.ori_session  group by ori having count = 1) t7 where  user_id = {user_id}''',
    客服消息量='''select count(distinct msg_id) from (select ori from (select ori_session as ori from chat_session where cid = '{cid}'  and created >= '{start}' and created < '{end}' and creator in (1,8)) s1 left join chat_session s2 on s1.ori = s2.ori_session where creator != 8 )  s left join (select l1.sid,s1.ori_session,l1.created,l1.raw,l1.msg_id,s1.user_id from (select * from chat_log where cid = '{cid}'  and created >= '{start}' and created < '{end}' and ((raw like '%%"from": "kf"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%'))) l1 left join chat_session s1 on l1.sid = s1.sid order by created asc)  t on s.ori = t.ori_session where user_id = {user_id}''',

    访客消息量='''select count(distinct msg_id) from (select ori from (select ori_session as ori from chat_session where cid = '{cid}'  and created >= '{start}' and created < '{end}' and creator in (1,8)) s1 left join chat_session s2 on s1.ori = s2.ori_session where creator != 8 )  s left join (select l1.sid,s1.ori_session,l1.created,l1.raw,l1.msg_id,s1. user_id from (select * from chat_log where cid = '{cid}'  and created >= '{start}' and created < '{end}' and (raw like '%%"from": "user"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%' and raw not like '%%"text": "转机器人"%%')) l1 left join chat_session s1 on l1.sid = s1.sid order by created asc)  t on s.ori = t.ori_session where  user_id = {user_id}''',
)

sql_客服详情_非趋势 = dict(
    接入会话量="select count(distinct sid) from (select ori_session as ori1 from chat_session where cid = '{cid}' and creator in (1,8) and status = 2 and  created < '{end}') t1 right join (select * from chat_session where creator in (1,4,5,6,7,9,10,11,12,13,14,15,16,17,18)  and status = 2 and cid = '{cid}' and created >= '{start}' and created < '{end}' and  user_id = '{user_id}') t2 on t1.ori1 = t2.ori_session where ori1 is not null and creator != 8",
    结束会话量='''select count(sid) from (select t1.* from (select s.* from(select * from chat_session where creator in (1,4,5,6,7,9,10,11,12,13,14,15,16,17,18) and status = 2) s right join (select sid as lsid from chat_log where source = 9 and raw like '%%"kf_id": "{user_id}"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%' and cid = '{cid}' and created >= '{start}' and created < '{end}') l on s.sid = l.lsid where sid is not null) t1 left join (select * from chat_session where creator in (1,8,9,10,11,12,13,14,15) and status = 2 and cid = '{cid}' and created < '{end}') t2 on t1.ori_session = t2.sid group by sid) t3 where stop_way in (0,1,2,3,6,12,27)''',
    主动会话量="select count(*) from chat_session where creator in (2,3) and  cid = '{cid}' and created >= '{start}' and created < '{end}' and  user_id = '{user_id}'",
    有效会话量='''select count(distinct sid) from (select ori_session as ori1 from chat_session where cid = '{cid}' and creator in (1,8) and status = 2 and created < '{end}') t1 right join (select * from (select * from chat_session where status = 2 and user_id = '{user_id}' and created >= '{start}' and created < '{end}' ) s right join (select sid as lsid from chat_log where raw like '%%"from": "user"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%' and raw not like '%%"text": "转机器人"%%' and cid = '{cid}' and created >= '{start}') l on s.sid = l.lsid) t2 on t1.ori1 = t2.ori_session where ori1 is not null and creator != 8''',
    主动转接量="select count(*) from chat_session where creator in (1,4,5,6,7,9,10,11,12,13,14,15,16,17,18) and stop_way in (9,25) and  cid = '{cid}' and created >= '{start}' and created < '{end}' and  user_id = '{user_id}'",
    平均接待时长='''select format(sum(dif_second)/count(*),0) from (select *,(UNIX_TIMESTAMP(stop_time) - UNIX_TIMESTAMP(created)) dif_second from (select t1.* from (select * from chat_session where cid = 149 and creator in (1,8,9,10,11,12,13,14,15) and  created < '2018-12-18') t1 right join (select s.ori_session,lsid,l.raw from chat_session s right join (select sid as lsid,created as lcreated,raw from chat_log where source = 9 and raw like '%%"from": "kf"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%' and cid = {cid} and created >= '{start}') l on s.sid = l.lsid where created >= '{start}' and created < '{end}' and user_id = {user_id} and status = 2) t2 on t1.sid = t2.ori_session where sid is not null and creator != 8 group by sid) t4 ) t5 ''',
    接待时长大于8min='''select format(count(case when dif_second>480 then 1 else null end)/count(distinct sid),4) from (select *,(UNIX_TIMESTAMP(stop_time) - UNIX_TIMESTAMP(created)) dif_second from (select t1.* from (select * from chat_session where cid = 149 and creator in (1,8,9,10,11,12,13,14,15) and  created < '2018-12-18') t1 right join (select s.ori_session,lsid,l.raw from chat_session s right join (select sid as lsid,created as lcreated,raw from chat_log where source = 9 and raw like '%%"from": "kf"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%' and cid = {cid} and created >= '{start}') l on s.sid = l.lsid where created >= '{start}' and created < '{end}' and user_id = {user_id} and status = 2) t2 on t1.sid = t2.ori_session where sid is not null and creator != 8 group by sid) t4 ) t5 ''',
    接待时长介于6min到8min='''select format(count(case when dif_second>360 and dif_second<=480 then 1 else null end)/count(distinct sid),4) from (select *,(UNIX_TIMESTAMP(stop_time) - UNIX_TIMESTAMP(created)) dif_second from (select t1.* from (select * from chat_session where cid = 149 and creator in (1,8,9,10,11,12,13,14,15) and  created < '2018-12-18') t1 right join (select s.ori_session,lsid,l.raw from chat_session s right join (select sid as lsid,created as lcreated,raw from chat_log where source = 9 and raw like '%%"from": "kf"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%' and cid = {cid} and created >= '{start}') l on s.sid = l.lsid where created >= '{start}' and created < '{end}' and user_id = {user_id} and status = 2) t2 on t1.sid = t2.ori_session where sid is not null and creator != 8 group by sid) t4 ) t5 ''',
    接待时长介于4min到6min='''select format(count(case when dif_second>240 and dif_second<=360 then 1 else null end)/count(distinct sid),4) from (select *,(UNIX_TIMESTAMP(stop_time) - UNIX_TIMESTAMP(created)) dif_second from (select t1.* from (select * from chat_session where cid = 149 and creator in (1,8,9,10,11,12,13,14,15) and  created < '2018-12-18') t1 right join (select s.ori_session,lsid,l.raw from chat_session s right join (select sid as lsid,created as lcreated,raw from chat_log where source = 9 and raw like '%%"from": "kf"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%' and cid = {cid} and created >= '{start}') l on s.sid = l.lsid where created >= '{start}' and created < '{end}' and user_id = {user_id} and status = 2) t2 on t1.sid = t2.ori_session where sid is not null and creator != 8 group by sid) t4 ) t5 ''',
    接待时长介于2min到4min='''select format(count(case when dif_second>120 and dif_second<=240 then 1 else null end)/count(distinct sid),4) from (select *,(UNIX_TIMESTAMP(stop_time) - UNIX_TIMESTAMP(created)) dif_second from (select t1.* from (select * from chat_session where cid = 149 and creator in (1,8,9,10,11,12,13,14,15) and  created < '2018-12-18') t1 right join (select s.ori_session,lsid,l.raw from chat_session s right join (select sid as lsid,created as lcreated,raw from chat_log where source = 9 and raw like '%%"from": "kf"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%' and cid = {cid} and created >= '{start}') l on s.sid = l.lsid where created >= '{start}' and created < '{end}' and user_id = {user_id} and status = 2) t2 on t1.sid = t2.ori_session where sid is not null and creator != 8 group by sid) t4 ) t5 ''',
    接待时长小于等于2min='''select format(count(case when dif_second<=120 then 1 else null end)/count(distinct sid),4) from (select *,(UNIX_TIMESTAMP(stop_time) - UNIX_TIMESTAMP(created)) dif_second from (select t1.* from (select * from chat_session where cid = 149 and creator in (1,8,9,10,11,12,13,14,15) and  created < '2018-12-18') t1 right join (select s.ori_session,lsid,l.raw from chat_session s right join (select sid as lsid,created as lcreated,raw from chat_log where source = 9 and raw like '%%"from": "kf"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%' and cid = {cid} and created >= '{start}') l on s.sid = l.lsid where created >= '{start}' and created < '{end}' and user_id = {user_id} and status = 2) t2 on t1.sid = t2.ori_session where sid is not null and creator != 8 group by sid) t4 ) t5 ''',
    平均首次响应时长='''select format(sum(t3.dif_second)/count(*),0) from (select *,(UNIX_TIMESTAMP(t2.created2) - UNIX_TIMESTAMP(t2.created1)) dif_second from (select * from (select s.creator,s.created as created1,lt.created as created2 from chat_session s right join (select * from (select sid,created from chat_log where source = 9 and raw like '%%"kf_id": "{user_id}"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%' and  cid = '{cid}' and created >= '{start}' and created < '{end}') l group by l.sid having min(l.created)) lt on s.sid = lt.sid) t where t.creator in (1,4,5,6,7,9,10,11,12,13,14,15)) t2) t3''',
    首次响应时长大于1min占比='''select format(count(case when t3.dif_second>60 then 1 else null end)/count(*),4) from (select *,(UNIX_TIMESTAMP(t2.created2) - UNIX_TIMESTAMP(t2.created1)) dif_second from (select * from (select s.creator,s.created as created1,lt.created as created2 from chat_session s right join (select * from (select sid,created from chat_log where source = 9 and raw like '%%"kf_id": "{user_id}"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%' and  cid = '{cid}' and created >= '{start}' and created < '{end}') l group by l.sid having min(l.created)) lt on s.sid = lt.sid) t where t.creator in (1,4,5,6,7,9,10,11,12,13,14,15)) t2) t3''',
    首次响应时长介于45s到1min占比='''select format(count(case when t3.dif_second>45 and t3.dif_second <= 60 then 1 else null end)/count(*),4) from (select *,(UNIX_TIMESTAMP(t2.created2) - UNIX_TIMESTAMP(t2.created1)) dif_second from (select * from (select s.creator,s.created as created1,lt.created as created2 from chat_session s right join (select * from (select sid,created from chat_log where source = 9 and raw like '%%"kf_id": "{user_id}"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%' and  cid = '{cid}' and created >= '{start}' and created < '{end}') l group by l.sid having min(l.created)) lt on s.sid = lt.sid) t where t.creator in (1,4,5,6,7,9,10,11,12,13,14,15)) t2) t3''',
    首次响应时长介于30s到45s占比='''select format(count(case when t3.dif_second > 30 and t3.dif_second <= 45 then 1 else null end)/count(*),4) from (select *,(UNIX_TIMESTAMP(t2.created2) - UNIX_TIMESTAMP(t2.created1)) dif_second from (select * from (select s.creator,s.created as created1,lt.created as created2 from chat_session s right join (select * from (select sid,created from chat_log where source = 9 and raw like '%%"kf_id": "{user_id}"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%' and  cid = '{cid}' and created >= '{start}' and created < '{end}') l group by l.sid having min(l.created)) lt on s.sid = lt.sid) t where t.creator in (1,4,5,6,7,9,10,11,12,13,14,15)) t2) t3''',
    首次响应时长介于15s到30s占比='''select format(count(case when t3.dif_second > 15 and t3.dif_second <= 30 then 1 else null end)/count(*),4) from (select *,(UNIX_TIMESTAMP(t2.created2) - UNIX_TIMESTAMP(t2.created1)) dif_second from (select * from (select s.creator,s.created as created1,lt.created as created2 from chat_session s right join (select * from (select sid,created from chat_log where source = 9 and raw like '%%"kf_id": "{user_id}"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%' and  cid = '{cid}' and created >= '{start}' and created < '{end}') l group by l.sid having min(l.created)) lt on s.sid = lt.sid) t where t.creator in (1,4,5,6,7,9,10,11,12,13,14,15)) t2) t3''',
    首次响应时长小于等于15s占比='''select format(count(case when t3.dif_second <= 15 then 1 else null end)/count(*),4) from (select *,(UNIX_TIMESTAMP(t2.created2) - UNIX_TIMESTAMP(t2.created1)) dif_second from (select * from (select s.creator,s.created as created1,lt.created as created2 from chat_session s right join (select * from (select sid,created from chat_log where source = 9 and raw like '%%"kf_id": "{user_id}"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%' and  cid = '{cid}' and created >= '{start}' and created < '{end}') l group by l.sid having min(l.created)) lt on s.sid = lt.sid) t where t.creator in (1,4,5,6,7,9,10,11,12,13,14,15)) t2) t3''',
    平均响应时长='''select format(sum(dif_second)/count(*),0) from (select *,(UNIX_TIMESTAMP(t6.created2) - UNIX_TIMESTAMP(t6.created1)) dif_second from (select s.sid as sid1,t5.* from (select sid from (select ori_session as ori from chat_session where cid = '{cid}' and  created >= '{start}' and created < '{end}' and user_id = {user_id} and creator in (1,8)) s1 left join chat_session s2 on s1.ori = s2.ori_session where creator != 8 )  s left join (select * from (select * from (select t1.sid,t1.created as created1,t1.raw as raw1,t2.created as created2,t2.raw as raw2  from (select * from chat_log where source = 9 and cid = '{cid}' and  created >= '{start}' and created < '{end}' and ((raw like '%%"from": "user"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%' and raw not like '%%"text": "转机器人"%%') or (raw like '%%"event_type": "分配客服"%%')) ) t1 right join (select * from chat_log where source = 9 and cid = '{cid}' and  created >= '{start}' and created < '{end}' and ((raw like '%%"from": "kf"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%'))) t2 on t1.sid = t2.sid having created2 > created1 ) t3 group by created1 having min(created2) ) t4 group by created2 having min(created1)) t5 on s.sid = t5.sid group by created1) t6 where sid is not null) t7''',
    响应时长大于1min占比='''select format(count(case when dif_second>60 then 1 else null end)/count(*),4) from (select *,(UNIX_TIMESTAMP(t6.created2) - UNIX_TIMESTAMP(t6.created1)) dif_second from (select s.sid as sid1,t5.* from (select sid from (select ori_session as ori from chat_session where cid = '{cid}' and  created >= '{start}' and created < '{end}' and user_id = {user_id} and creator in (1,8)) s1 left join chat_session s2 on s1.ori = s2.ori_session where creator != 8 )  s left join (select * from (select * from (select t1.sid,t1.created as created1,t1.raw as raw1,t2.created as created2,t2.raw as raw2  from (select * from chat_log where source = 9 and cid = '{cid}' and  created >= '{start}' and created < '{end}' and ((raw like '%%"from": "user"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%' and raw not like '%%"text": "转机器人"%%') or (raw like '%%"event_type": "分配客服"%%')) ) t1 right join (select * from chat_log where source = 9 and cid = '{cid}' and  created >= '{start}' and created < '{end}' and ((raw like '%%"from": "kf"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%'))) t2 on t1.sid = t2.sid having created2 > created1 ) t3 group by created1 having min(created2) ) t4 group by created2 having min(created1)) t5 on s.sid = t5.sid group by created1) t6 where sid is not null) t7''',
    响应时长介于45s到1min占比='''select format(count(case when dif_second>45 and dif_second<=60 then 1 else null end)/count(*),4) from (select *,(UNIX_TIMESTAMP(t6.created2) - UNIX_TIMESTAMP(t6.created1)) dif_second from (select s.sid as sid1,t5.* from (select sid from (select ori_session as ori from chat_session where cid = '{cid}' and  created >= '{start}' and created < '{end}' and user_id = {user_id} and creator in (1,8)) s1 left join chat_session s2 on s1.ori = s2.ori_session where creator != 8 )  s left join (select * from (select * from (select t1.sid,t1.created as created1,t1.raw as raw1,t2.created as created2,t2.raw as raw2  from (select * from chat_log where source = 9 and cid = '{cid}' and  created >= '{start}' and created < '{end}' and ((raw like '%%"from": "user"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%' and raw not like '%%"text": "转机器人"%%') or (raw like '%%"event_type": "分配客服"%%')) ) t1 right join (select * from chat_log where source = 9 and cid = '{cid}' and  created >= '{start}' and created < '{end}' and ((raw like '%%"from": "kf"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%'))) t2 on t1.sid = t2.sid having created2 > created1 ) t3 group by created1 having min(created2) ) t4 group by created2 having min(created1)) t5 on s.sid = t5.sid group by created1) t6 where sid is not null) t7''',
    响应时长介于30s到45s占比='''select format(count(case when dif_second>30 and dif_second<=45 then 1 else null end)/count(*),4) from (select *,(UNIX_TIMESTAMP(t6.created2) - UNIX_TIMESTAMP(t6.created1)) dif_second from (select s.sid as sid1,t5.* from (select sid from (select ori_session as ori from chat_session where cid = '{cid}' and  created >= '{start}' and created < '{end}' and user_id = {user_id} and creator in (1,8)) s1 left join chat_session s2 on s1.ori = s2.ori_session where creator != 8 )  s left join (select * from (select * from (select t1.sid,t1.created as created1,t1.raw as raw1,t2.created as created2,t2.raw as raw2  from (select * from chat_log where source = 9 and cid = '{cid}' and  created >= '{start}' and created < '{end}' and ((raw like '%%"from": "user"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%' and raw not like '%%"text": "转机器人"%%') or (raw like '%%"event_type": "分配客服"%%')) ) t1 right join (select * from chat_log where source = 9 and cid = '{cid}' and  created >= '{start}' and created < '{end}' and ((raw like '%%"from": "kf"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%'))) t2 on t1.sid = t2.sid having created2 > created1 ) t3 group by created1 having min(created2) ) t4 group by created2 having min(created1)) t5 on s.sid = t5.sid group by created1) t6 where sid is not null) t7''',
    响应时长介于15s到30s占比='''select format(count(case when dif_second>15 and dif_second<=30 then 1 else null end)/count(*),4) from (select *,(UNIX_TIMESTAMP(t6.created2) - UNIX_TIMESTAMP(t6.created1)) dif_second from (select s.sid as sid1,t5.* from (select sid from (select ori_session as ori from chat_session where cid = '{cid}' and  created >= '{start}' and created < '{end}' and user_id = {user_id} and creator in (1,8)) s1 left join chat_session s2 on s1.ori = s2.ori_session where creator != 8 )  s left join (select * from (select * from (select t1.sid,t1.created as created1,t1.raw as raw1,t2.created as created2,t2.raw as raw2  from (select * from chat_log where source = 9 and cid = '{cid}' and  created >= '{start}' and created < '{end}' and ((raw like '%%"from": "user"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%' and raw not like '%%"text": "转机器人"%%') or (raw like '%%"event_type": "分配客服"%%')) ) t1 right join (select * from chat_log where source = 9 and cid = '{cid}' and  created >= '{start}' and created < '{end}' and ((raw like '%%"from": "kf"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%'))) t2 on t1.sid = t2.sid having created2 > created1 ) t3 group by created1 having min(created2) ) t4 group by created2 having min(created1)) t5 on s.sid = t5.sid group by created1) t6 where sid is not null) t7''',
    响应时长小于等于15s占比='''select format(count(case when dif_second<=15 then 1 else null end)/count(*),4) from (select *,(UNIX_TIMESTAMP(t6.created2) - UNIX_TIMESTAMP(t6.created1)) dif_second from (select s.sid as sid1,t5.* from (select sid from (select ori_session as ori from chat_session where cid = '{cid}' and  created >= '{start}' and created < '{end}' and user_id = {user_id} and creator in (1,8)) s1 left join chat_session s2 on s1.ori = s2.ori_session where creator != 8 )  s left join (select * from (select * from (select t1.sid,t1.created as created1,t1.raw as raw1,t2.created as created2,t2.raw as raw2  from (select * from chat_log where source = 9 and cid = '{cid}' and  created >= '{start}' and created < '{end}' and ((raw like '%%"from": "user"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%' and raw not like '%%"text": "转机器人"%%') or (raw like '%%"event_type": "分配客服"%%')) ) t1 right join (select * from chat_log where source = 9 and cid = '{cid}' and  created >= '{start}' and created < '{end}' and ((raw like '%%"from": "kf"%%' and raw like '%%"is_sys_send": 0%%' and raw not like '%%"msg_type": "event"%%'))) t2 on t1.sid = t2.sid having created2 > created1 ) t3 group by created1 having min(created2) ) t4 group by created2 having min(created1)) t5 on s.sid = t5.sid group by created1) t6 where sid is not null) t7''',
    已解决="select count(case when question_status = 1 then 1 else null end) from (select ori_session as ori1 from chat_session where cid = '{cid}' and creator in (1,8) and status = 2 and  created < '{end}') t1 right join (select * from chat_session where creator in (1,4,5,6,7,9,10,11,12,13,14,15,16,17,18)  and status = 2 and cid = '{cid}' and created >= '{start}' and created < '{end}' and  user_id = '{user_id}') t2 on t1.ori1 = t2.ori_session where ori1 is not null and creator != 8",
    未解决="select count(case when question_status = 0 then 1 else null end) from (select ori_session as ori1 from chat_session where cid = '{cid}' and creator in (1,8) and status = 2 and  created < '{end}') t1 right join (select * from chat_session where creator in (1,4,5,6,7,9,10,11,12,13,14,15,16,17,18)  and status = 2 and cid = '{cid}' and created >= '{start}' and created < '{end}' and  user_id = '{user_id}') t2 on t1.ori1 = t2.ori_session where ori1 is not null and creator != 8",
    参评率='''select format(count(case when satisfaction is not null then 1 else null end)/count(sid),4) from (select ori_session as ori from chat_session where cid = '{cid}' and created >= '{start}' and created < '{end}' and creator in (1,8)) s1 left join chat_session s2 on s1.ori = s2.ori_session where creator != 8 and  user_id = {user_id}''',

    非常满意='''select count(case when satisfaction=5 then 1 else null end) from (select ori_session as ori from chat_session where cid = '{cid}' and created >= '{start}' and created < '{end}' and creator in (1,8)) s1 left join chat_session s2 on s1.ori = s2.ori_session where creator != 8 and  user_id = {user_id}''',

    满意='''select count(case when satisfaction=4 then 1 else null end) from (select ori_session as ori from chat_session where cid = '{cid}' and created >= '{start}'  and created < '{end}' and creator in (1,8)) s1 left join chat_session s2 on s1.ori = s2.ori_session where creator != 8 and  user_id = {user_id}''',

    一般='''select count(case when satisfaction=3 then 1 else null end) from (select ori_session as ori from chat_session where cid = '{cid}' and created >= '{start}'  and created < '{end}' and creator in (1,8)) s1 left join chat_session s2 on s1.ori = s2.ori_session where creator != 8 and  user_id = {user_id}''',

    不满意='''select count(case when satisfaction=2 then 1 else null end) from (select ori_session as ori from chat_session where cid = '{cid}'  and created >= '{start}' and created < '{end}' and creator in (1,8)) s1 left join chat_session s2 on s1.ori = s2.ori_session where creator != 8 and  user_id = {user_id}''',
    非常不满意='''select count(case when satisfaction=1 then 1 else null end) from (select ori_session as ori from chat_session where cid = '{cid}'  and created >= '{start}' and created < '{end}' and creator in (1,8)) s1 left join chat_session s2 on s1.ori = s2.ori_session where creator != 8 and  user_id = {user_id}''')

sql_客服考勤_状态 = dict(
    登录总时长='''select action,DATE_FORMAT(created,'%Y-%m-%d %T') as created from ((select * from (select action , created from log where cid = '{cid}' and created < '{start}'  and  user_id = '{user_id}' and action in ( "登录","注销") order by created desc) t having max(created)) union (select action , created from log where created >= '{start}' and created < '{end}' and cid = '{cid}' and  user_id = '{user_id}' and action in ( "登录","注销")) order by created asc) t''',
    可接待总时长='''select action,DATE_FORMAT(created,'%Y-%m-%d %T') as created from ((select * from (select content as action , created from log where cid = '{cid}' and created < '{start}'  and  user_id = '{user_id}' and content in ( "可接待","不可接待") order by created desc) t having max(created)) union (select content as action , created from log where created >= '{start}' and created < '{end}' and cid = '{cid}' and  user_id = '{user_id}' and content in ("可接待","不可接待")) order by created asc) t''',
    在线总时长='''select action,DATE_FORMAT(created,'%Y-%m-%d %T') as created from ((select * from (select raw as action , created from log where cid = '{cid}' and created < '{start}'  and  user_id = '{user_id}' and action = '客服上下线' order by created desc) t having max(created)) union (select raw as action , created from log where created >= '{start}' and created < '{end}' and cid = '{cid}' and  user_id = '{user_id}' and action = '客服上下线') order by created asc) t''',
)

sql_客服考勤_服务 = dict(
    服务总时长='''select created,stop_time from (select ori_session as ori1 from chat_session where cid = '{cid}' and creator in (1,8) and status = 2 and  created < '{end}') t1 right join (select * from chat_session where creator in (1,4,5,6,7,9,10,11,12,13,14,15,16,17,18)  and status = 2 and cid = '{cid}' and created >= '{start}' and created < '{end}' and  user_id = '{user_id}' ) t2 on t1.ori1 = t2.ori_session where ori1 is not null and creator != 8 order by created asc'''
)

sql_访客 = dict(
    访问量='''select count(*) from chat_session where cid = '{cid}' and created >= '{start}' and created < '{end}' and creator = 0''',
    访客人数='''select count(distinct uid) from chat_session where cid = '{cid}' and created >= '{start}' and created < '{end}' and creator = 0''',
    新访客="select count(case when created >= '{start}' then 1 else null end) from (select distinct uid from chat_session where cid = '{cid}' and created >= '{start}' and created < '{end}' and creator = 0) t1 left join chat_user t2 on t1.uid = t2.uid",
    老访客="select count(case when created < '{start}' then 1 else null end) from (select distinct uid from chat_session where cid = '{cid}' and created >= '{start}' and created < '{end}' and creator = 0) t1 left join chat_user t2 on t1.uid = t2.uid",
    微信访客="select count(case when source = 'weixin' then 1 else null end) from (select distinct uid from chat_session where cid = '{cid}' and created >= '{start}' and created < '{end}' and creator = 0) t1 left join chat_user t2 on t1.uid = t2.uid",
    网页访客="select count(case when source = 'h5' then 1 else null end) from (select distinct uid from chat_session where cid = '{cid}' and created >= '{start}' and created < '{end}' and creator = 0) t1 left join chat_user t2 on t1.uid = t2.uid",
    非常满意='''select count(*) from chat_session where cid = '{cid}' and created >= '{start}' and created < '{end}' and satisfaction = 5''',

    满意='''select count(*) from  chat_session where cid = '{cid}' and created >= '{start}' and created < '{end}' and satisfaction = 4''',

    一般='''select count(*) from  chat_session where cid = '{cid}' and created >= '{start}' and created < '{end}' and satisfaction = 3''',

    不满意='''select count(*) from  chat_session where cid = '{cid}' and created >= '{start}' and created < '{end}' and satisfaction = 2''',

    非常不满意='''select count(*) from  chat_session where cid = '{cid}' and created >= '{start}' and created < '{end}'and satisfaction = 1''',
)

sql_访客分布 = dict(
    访客来源='''select name,count(name) from (select u.uid, u.entry_id from (select uid from chat_session where cid = '{cid}' and created >= '{start}' and created < '{end}' and creator = 0 group by uid) s left join chat_user u on s.uid = u.uid ) t left join company_multi_entry c on t.entry_id = c.id group by name''',
    访客地域='''select province,count(province) from (select uid from chat_session where cid = '{cid}' and created >= '{start}' and created < '{end}' and creator = 0 group by uid) s left join chat_user u on s.uid = u.uid group by province''',
    访问量地域='''select province,count(province) from (select sid,uid from chat_session where cid = '{cid}' and created >= '{start}' and created < '{end}' and creator = 0) s left join chat_user u on s.uid = u.uid group by province''',
)
#
# return 数据总览, 机器人数据, 客服数据总览, 客服工作量, 客服工作质量,客服详情,访客, 客服考勤,访客分布
